/**
 * Copyright 2017 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

function getScopedCid(e,t,n){if(scopedCidCallbacks[e])return void scopedCidCallbacks[e].push(n);scopedCidCallbacks[e]=[n];var o,r=wrapCallbacks(scopedCidCallbacks[e]);poll(200,function(){return o=getCookie(AMP_TOKEN),o!==TokenStatus.RETRIEVING},function(){var n=o===TokenStatus.NOT_FOUND&&isReferrerProxyOrigin();return!n&&isStatusToken(o)?void(o===TokenStatus.OPT_OUT?r(null,TokenStatus.OPT_OUT):o===TokenStatus.NOT_FOUND?r(null,null):r(o===TokenStatus.ERROR?new Error("There was an error in previous request. Try later."):new Error("Invalid token state: "+o))):((!o||isStatusToken(o))&&persistToken(TokenStatus.RETRIEVING,TIMEOUT),void fetchCid(GOOGLE_API_URL+t,e,o,r))})}function fetchCid(e,t,n,o){var r={originScope:t};n&&(r.securityToken=n),fetchJson(e,r,TIMEOUT,function(e,t){e?(persistToken(TokenStatus.ERROR,TIMEOUT),o(e)):t.optOut?(persistToken(TokenStatus.OPT_OUT,YEAR),o(null,TokenStatus.OPT_OUT)):t.clientId?(persistToken(t.securityToken,YEAR),o(null,t.clientId)):(persistToken(TokenStatus.NOT_FOUND,HOUR),o(null,null))})}function wrapCallbacks(e){return function(){var t=arguments;e.forEach(function(e){e.apply(null,t)})}}function persistToken(e,t){e&&setCookie(AMP_TOKEN,e,Date.now()+t)}function isReferrerProxyOrigin(){return PROXY_ORIGIN_URL_REGEX.test(self.document.referrer)}function isStatusToken(e){return!!e&&"$"===e[0]}function poll(e,t,n){var o=self.setInterval(function(){t()&&(self.clearInterval(o),n())},e)}function getCookie(e){for(var t=self.document.cookie.split(";"),n=0;n<t.length;n++){var o=t[n].trim(),r=o.split("=",2);if(2===r.length&&decodeURIComponent(r[0])===e)return decodeURIComponent(r[1])}return null}function setCookie(e,t,n){self.document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+"; path=/; expires="+new Date(n).toUTCString()}function fetchJson(e,t,n,o){var r=oneTime(o);self.setTimeout(function(){r(new Error("Request timed out"))},n);var s=createPostXhrRequest(e);s.onreadystatechange=function(){if(!(s.readyState<2)){if(s.status<100||s.status>599)return s.onreadystatechange=null,void r(new Error("Unknown HTTP status"+s.status));if(4===s.readyState)try{var e=JSON.parse(s.responseText);s.status>=400?r(new Error(e.error?e.error.message:"Invalid response: "+s.responseText)):r(null,e)}catch(t){r(new Error("Invalid response: "+s.responseText))}}},s.onerror=function(){r(new Error("Network failure"))},s.onabort=function(){r(new Error("Request aborted"))},s.send(JSON.stringify(t))}function createPostXhrRequest(e){var t=new self.XMLHttpRequest;if("withCredentials"in t)t.open("POST",e,!0);else{if("undefined"==typeof self.XDomainRequest)throw new Error("CORS is not supported");t=new self.XDomainRequest,t.open("POST",e)}return t.withCredentials=!0,t.setRequestHeader("Content-Type","text/plain;charset=utf-8"),t.setRequestHeader("Accept","application/json"),t}function oneTime(e){var t=!1;return function(){t||(e.apply(null,arguments),t=!0)}}var GOOGLE_API_URL="https://ampcid.google.com/v1/publisher:getClientId?key=",AMP_TOKEN="AMP_TOKEN",TokenStatus={RETRIEVING:"$RETRIEVING",OPT_OUT:"$OPT_OUT",NOT_FOUND:"$NOT_FOUND",ERROR:"$ERROR"},TIMEOUT=3e4,HOUR=36e5,DAY=24*HOUR,YEAR=365*DAY,PROXY_ORIGIN_URL_REGEX=/^https:\/\/([a-zA-Z0-9_-]+\.)?cdn\.ampproject\.org/,scopedCidCallbacks={};self.GoogleAmpCidApi={getScopedCid:getScopedCid},"[object Array]"===Object.prototype.toString.call(self.googleAmpCidApiOnload)&&self.googleAmpCidApiOnload.forEach(function(e){e(self.GoogleAmpCidApi)}),self.googleAmpCidApiOnload={push:function(e){e(self.GoogleAmpCidApi)}};
